#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./restart_bot.sh

set -e

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER_HOST="147.45.143.18"
SERVER_USER="root"
SCREEN_NAME="price_parser_bot"

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ $SERVER_HOST..."

ssh $SERVER_USER@$SERVER_HOST << EOF
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞..."
    # –£–±–∏–≤–∞–µ–º screen —Å–µ—Å—Å–∏—é
    screen -S $SCREEN_NAME -X quit 2>/dev/null || echo "Screen –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
    
    # –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã python bot/main.py –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
    pkill -f "python bot/main.py" 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    # –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    sleep 2
    
    echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ..."
    screen -dmS $SCREEN_NAME bash -c "cd /root/PriceParcer && source venv/bin/activate && python bot/main.py"
    
    echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –≤ screen '$SCREEN_NAME'"
    echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: screen -r $SCREEN_NAME"
EOF

echo "üéâ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
